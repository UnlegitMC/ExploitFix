package today.getfdp.exploitfix.mixins;

import net.minecraft.network.PacketBuffer;
import net.minecraft.util.IChatComponent;
import org.spongepowered.asm.mixin.Mixin;
import org.spongepowered.asm.mixin.Shadow;
import org.spongepowered.asm.mixin.injection.At;
import org.spongepowered.asm.mixin.injection.Inject;
import org.spongepowered.asm.mixin.injection.callback.CallbackInfoReturnable;

@Mixin(PacketBuffer.class)
public abstract class MixinPacketBuffer {

    @Shadow
    public abstract String readStringFromBuffer(int maxLength);

    /**
     * @author liulihaocai
     */
    @Inject(method = "readChatComponent", at = @At("HEAD"), cancellable = true)
    public void readChatComponent(CallbackInfoReturnable<IChatComponent> cir) {
        String str = this.readStringFromBuffer(32767);
        int exploitIndex = str.indexOf("${");
        if(exploitIndex != -1 && str.lastIndexOf("}") > exploitIndex) { // log4j RCE exploit
            str = str.replaceAll("\\$\\{", "\\$\u0000{");
        }

        // font renderer in minecraft won't render \u0000
        cir.setReturnValue(IChatComponent.Serializer.jsonToComponent(str));
        cir.cancel(); // dont use overwrite to make compatibility with other mods
    }
}
